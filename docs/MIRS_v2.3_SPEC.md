# MIRS v2.3 開發規格書 (MVP 聚焦版)

**版本：** v2.3  
**最後更新：** 2024-11-20  
**核心精神：** 減法思維、離線優先、單機驗證  

---

## 1. 專案概述

### 1.1 核心價值定位
**MIRS 首先是一個「數位化的戰備物資登記簿」**

- ✅ 它必須是一個好用的單機庫存軟體，好用到護理師願意放棄紙筆和 Excel
- ✅ 其次才是災難時的資料匯出工具
- ❌ 它不是 HIS（醫院資訊系統）
- ❌ 它不是即時戰情系統（Phase 1 不做網路傳輸）

### 1.2 階段目標

#### Phase 1：單機信任期 (M1-M3)
**目標：** 讓 1-2 家診所/衛生所願意在平時演習使用它  
**關鍵：** 不需網路，不需伺服器，一台電腦就能跑

#### Phase 2：資料流動期 (M4-M6)  
**目標：** 驗證「資料能離開這台機器」並被匯總  
**方法：** USB 匯出/匯入 或 簡單 HTTP Upload（不使用 VPN）

#### Phase 3：網路韌性期 (M7+)
**目標：** 這時候才考慮 Tailscale/VPN 與即時戰情室  
**條件：** Phase 1 和 Phase 2 必須完全穩定

---

## 2. 功能規格 (Feature Specifications)

### 2.1 核心功能（Phase 1 必須完成）

#### ✅ 庫存管理
- 藥品/血品/耗材的基本資訊（名稱、代碼、規格、效期）
- 進貨登記
- 庫存查詢（含效期警示）
- 批號管理

#### ✅ 領用/發放
- 正常領用流程：選藥 → 掃碼/選數量 → 請求審核 → 藥師 PIN → 扣庫存
- 支援 Barcode Scanner 輸入

#### ✅ 緊急領用（Break-the-Glass）
- **UI 設計：** 在 PIN 碼輸入框旁增加紅色按鈕：「緊急領用 (略過 PIN)」
- **前置條件：** 點擊時必須輸入「緊急原因」（5-50 字，防止濫用）
- **後端邏輯：**
  - 立即扣庫存
  - 紀錄狀態為 `EMERGENCY`
  - 紀錄 `emergency_reason`、`dispensed_by`（領用人）
- **事後稽核：** 藥師上班時，系統首頁顯示「待確認的緊急領用清單」，藥師可批次確認

#### ✅ 資料匯出/匯入
- **匯出：** 點擊按鈕下載 `.json` 檔到 USB
- **檔名格式：** `mirs_backup_[StationID]_[YYYYMMDD_HHMMSS].json`
- **匯入：** 上傳 JSON 檔，系統自動合併資料（避免重複）
- **Phase 1 不做加密** - 告訴使用者保管好 USB 即可

#### ✅ 到期警示
- 系統每日檢查藥品效期
- 距離效期 7 天內：顯示黃色警示
- 距離效期 1 天內：顯示紅色警示

### 2.2 選填功能（Phase 1 可有可無）

#### 🔶 病患參考編號（Patient Reference ID）
- **資料表：** 在 `DispenseRecord` 加入 `patient_ref_id` (String, Optional)
- **功能：** 支援掃描 Triage Tag 上的 Barcode/QR Code
- **限制：** MIRS 不做病患資料庫，不做檢傷分類邏輯
- **用途：** 純粹作為「這支藥用在哪個傷患身上」的標記，方便事後追蹤

---

## 3. 技術架構 (Tech Stack)

### 3.1 後端 (Backend)
- **框架：** FastAPI (Python 3.11+)
- **資料庫：** SQLite（單檔易備份，免安裝 PostgreSQL）
- **ORM：** SQLAlchemy
- **驗證：** 簡單的 PIN 碼驗證（不使用複雜的 OAuth）

### 3.2 前端 (Frontend)
- **模板引擎：** Jinja2
- **互動框架：** HTMX + Alpine.js（減少前後端分離的開發負擔）
- **樣式：** Tailwind CSS
- **目標：** 行動裝置友善（Responsive Design）

### 3.3 部署方式
- **Docker Compose** - 提供給有 IT 團隊的大型醫院
- **安裝腳本** - 一鍵安裝（適合 Raspberry Pi）
- **推薦硬體：** Raspberry Pi 4B (8GB) + SanDisk Extreme Pro 32GB SD 卡

### 3.4 Phase 1 明確排除的技術
- ❌ 不做 VPN（Tailscale/Headscale 留到 Phase 3）
- ❌ 不做 Starlink 流量控制
- ❌ 不做複雜的網路同步
- ❌ 不做即時戰情室

---

## 4. 資料庫 Schema 修正

### 4.1 DispenseRecord 資料表（核心變更）

```python
class DispenseRecord(Base):
    __tablename__ = "dispense_records"
    
    id: int  # Primary Key
    item_id: int  # Foreign Key to Item
    quantity: int
    
    # 人員紀錄
    dispensed_by: str  # 領用人（必填）
    approved_by: str | None  # 審核人（可為空，如果是緊急領用）
    
    # 狀態管理
    status: str  # 'APPROVED' | 'EMERGENCY' | 'PENDING'
    emergency_reason: str | None  # 緊急原因（當 status='EMERGENCY' 時必填）
    
    # 選填：病患參考
    patient_ref_id: str | None  # 可掃描 Triage Tag
    
    # 時間戳記
    created_at: datetime
    updated_at: datetime
```

### 4.2 遷移策略
- 如果使用 Alembic：建立 migration script
- 如果沒有：更新 `create_tables()` 函數

---

## 5. UI/UX 設計原則

### 5.1 設計哲學
- **極簡：** 每個畫面只做一件事
- **大按鈕：** 適合戴手套的醫護人員操作
- **容錯性：** 誤按不會造成災難（例如刪除前要二次確認）

### 5.2 關鍵畫面

#### 領藥畫面
```
┌─────────────────────────────────┐
│ 選擇藥品: [Morphine 10mg ▼]    │
│ 數量: [____] (目前庫存: 50)     │
│ 領用人: [護理師 A ▼]            │
│                                 │
│ 病患編號 (選填): [____] 📷      │
│                                 │
│ ┌──────────┐  ┌──────────────┐ │
│ │ 送出審核  │  │ 🚨 緊急領用  │ │
│ └──────────┘  └──────────────┘ │
└─────────────────────────────────┘
```

點擊「緊急領用」時：
```
┌─────────────────────────────────┐
│ ⚠️  緊急領用原因                │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ 例如：大量傷患湧入          │ │
│ │                             │ │
│ └─────────────────────────────┘ │
│                                 │
│ ┌──────────┐  ┌──────────┐    │
│ │   確定    │  │   取消    │    │
│ └──────────┘  └──────────┘    │
└─────────────────────────────────┘
```

---

## 6. 開發時程 (Timeline)

### Sprint 1-3: 核心單機版 (6-8 週)

**Sprint 1 (2-3 週):**
- [ ] 資料庫 Schema 定案（含 `status`, `emergency_reason`）
- [ ] 完成核心 CRUD API（進貨、庫存查詢）
- [ ] 測試資料建立腳本

**Sprint 2 (2-3 週):**
- [ ] 實作正常領用流程（含藥師 PIN 審核）
- [ ] 實作「緊急領用」邏輯
- [ ] 基本 UI（使用 HTMX）

**Sprint 3 (2 週):**
- [ ] JSON 匯出/匯入功能
- [ ] 到期警示邏輯
- [ ] **交付物：** 找一位護理師朋友進行可用性測試

### Sprint 4-6: 穩定與封裝 (4-6 週)

**Sprint 4 (2 週):**
- [ ] Docker Compose 設定
- [ ] 安裝腳本（Raspberry Pi）
- [ ] 系統效能優化

**Sprint 5 (2 週):**
- [ ] 使用者手冊撰寫
- [ ] 常見問題排除文件
- [ ] 示範影片錄製

**Sprint 6 (2 週):**
- [ ] 在 1 個真實站點部署
- [ ] 試跑 1 週
- [ ] 收集回饋並修正

### Sprint 7+: 基礎聯網 (視 Phase 1 回饋而定)
- [ ] Hub 端匯總 Dashboard（讀取上傳的 JSON）
- [ ] Spoke 端簡單的 API 上傳功能

---

## 7. 測試策略

### 7.1 單元測試
- 使用 pytest
- 測試核心邏輯（庫存扣減、效期計算）

### 7.2 整合測試
- 測試完整流程：建藥品 → 進貨 → 領用 → 緊急領用 → 匯出 JSON

### 7.3 真人測試
- **Week 6:** 找一個朋友（不一定要醫護背景）操作 15 分鐘
- **規則：** 你只能看，不能幫忙
- **目標：** 記錄所有「她卡住」的地方

---

## 8. 商業策略 (Go-to-Market)

### 8.1 目標客戶（優先順序）
1. **友善的衛生所/診所**（透過人脈）- 免費試用，換取 UX 回饋
2. **DMAT 協會**（透過參與演習）- 目標：成為演習標準工具
3. **政府標案**（最後才考慮）- 需要 3-5 個實際使用案例才能投標

### 8.2 定價策略（Phase 2 之後）
- **顧問費：** 教育訓練 + 系統建置協助（NT$ 50,000 / 次）
- **軟體訂閱：** NT$ 3,000 - 5,000 / 月 / 站點（依規模）

### 8.3 硬體策略
- **不賣硬體** - 提供「建議規格清單」
- 客戶自行採購，我們提供技術支援

---

## 9. 風險管理

### 9.1 技術風險
| 風險 | 緩解措施 |
|------|----------|
| SQLite 效能瓶頸 | 單站點資料量小（<10萬筆），足夠應付 |
| 資料遺失 | 每日自動備份 JSON 到 USB |
| 相容性問題 | 提供 Docker 版本，減少環境差異 |

### 9.2 市場風險
| 風險 | 緩解措施 |
|------|----------|
| 客戶認為「不會打仗」 | 改推「評鑑加分項」或「演習標準工具」 |
| 預算不足 | 先做免費試用，累積口碑 |
| 競品出現 | 專注離線場景，這是藍海市場 |

---

## 10. 成功指標 (Success Metrics)

### Phase 1 成功標準
- [ ] 1 個真實站點連續使用 1 個月
- [ ] 護理師願意放棄 Excel，改用 MIRS
- [ ] 零次資料遺失事件

### Phase 2 成功標準
- [ ] 3 個站點的資料能成功匯總
- [ ] 參與 1 次 DMAT 演習，無重大故障

### Phase 3 成功標準
- [ ] 10 個站點同時在線
- [ ] 拿到第一筆政府標案

---

## 11. 開發原則（給 AI 的指令）

### 11.1 Code Style
- 使用 Type Hints
- 函數不超過 50 行
- 每個函數只做一件事

### 11.2 Commit Message 格式
```
feat: 加入緊急領用功能
fix: 修正庫存扣減邏輯錯誤
docs: 更新使用者手冊
```

### 11.3 AI 協作規則
- **不要重寫整個檔案** - 除非檔案很小
- **一次只改一個功能** - 先 DB → 再 API → 最後 UI
- **改動前先給 diff** - 讓開發者確認

---

## 12. 附錄：不做的功能清單

為了避免 Scope Creep（範疇蔓延），以下功能**明確排除在 Phase 1**：

- ❌ 病患身分管理（HIS 功能）
- ❌ 複雜的權限管理（RBAC）
- ❌ 多語言支援（只做繁體中文）
- ❌ 自動訂貨系統
- ❌ 金流整合
- ❌ 行動 App（只做 Web）
- ❌ AI 預測庫存
- ❌ 區塊鏈不可竄改紀錄

**原則：能手動解決的，Phase 1 都手動。**

---

**版本歷史：**
- v2.3 (2024-11-20): MVP 聚焦版，移除所有網路傳輸功能
- v2.2 (2024-11-15): 包含 VPN 與戰情室（已廢棄）
- v2.1 (2024-11-10): 初版規劃

**聯絡人：** Chia-Wei Lin (tom@denovortho.com)
