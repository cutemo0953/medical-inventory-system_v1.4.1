<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç™‚ç«™åº«å­˜ç®¡ç†ç³»çµ± v1.4.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* æ·º teal èƒŒæ™¯æ¼¸è®Š */
        body {
            background: linear-gradient(135deg, #f0f9f8 0%, #e6f7f5 25%, #f5f8ff 50%, #faf5ff 75%, #fff 100%);
            background-attachment: fixed;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* è¡¨æ ¼æ–‘é¦¬ç´‹å„ªåŒ– */
        .table-hover tbody tr:hover {
            background-color: #f0f9ff;
            transition: background-color 0.2s;
        }

        /* v1.4.3 å·¥å…·åˆ—æ¨£å¼ */
        .items-toolbar {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
            color: #94a3b8;
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 0.625rem 2.5rem 0.625rem 2.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            transition: all 0.2s;
            background-color: white;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-clear {
            position: absolute;
            right: 0.5rem;
            padding: 0.25rem;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .search-clear:hover {
            background-color: #e2e8f0;
            color: #475569;
        }

        .filter-box, .sort-box {
            position: relative;
            min-width: 150px;
        }

        .filter-icon, .sort-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.25rem;
            height: 1.25rem;
            color: #94a3b8;
            pointer-events: none;
        }

        .filter-select, .sort-select {
            width: 100%;
            padding: 0.625rem 0.75rem 0.625rem 2.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-select:focus, .sort-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .export-box {
            display: flex;
            gap: 0.5rem;
        }

        .btn-export {
            padding: 0.625rem 1rem;
            background-color: white;
            color: #374151;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-export:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-export svg {
            width: 1rem;
            height: 1rem;
        }

        .items-stats {
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9375rem;
            color: #1e40af;
            font-weight: 500;
        }

        .items-stats strong {
            color: #1e3a8a;
            font-weight: 700;
            font-size: 1.125rem;
        }

        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ */
        @media (max-width: 767px) {
            .items-toolbar {
                flex-direction: column;
            }

            .search-box,
            .filter-box,
            .sort-box {
                width: 100%;
                min-width: auto;
            }

            .export-box {
                width: 100%;
                justify-content: space-between;
            }

            .btn-export {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div x-data="medicalInventory()" x-init="init()" x-cloak class="max-w-7xl mx-auto p-6">
        
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg class="w-16 h-16 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">é†«ç™‚ç«™åº«å­˜ç³»çµ±</h1>
                        <p class="text-base text-gray-500">v1.4.3 - æœå°‹èˆ‡åŒ¯å‡ºå¼·åŒ–ç‰ˆ</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">ç«™é»: <span class="font-semibold text-teal-600" x-text="stationId"></span></p>
                    <p class="text-xs text-gray-400" x-text="currentTime"></p>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">ç¸½ç‰©å“æ•¸</p>
                        <p class="text-2xl font-bold text-gray-800" x-text="stats.totalItems"></p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">åº«å­˜è­¦æˆ’</p>
                        <p class="text-2xl font-bold text-orange-600" x-text="stats.lowStockItems"></p>
                    </div>
                    <div class="p-3 bg-orange-100 rounded-lg">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">è¡€è¢‹åº«å­˜</p>
                        <p class="text-2xl font-bold text-red-600"><span x-text="stats.totalBlood"></span> U</p>
                    </div>
                    <div class="p-3 bg-red-100 rounded-lg">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">è¨­å‚™è­¦å ±</p>
                        <p class="text-2xl font-bold text-purple-600" x-text="stats.equipmentAlerts"></p>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†é é¸å–® -->
        <div class="bg-white rounded-xl shadow mb-6">
            <div class="flex space-x-1 p-2">
                <button @click="switchTab('items')" 
                        :class="currentTab === 'items' ? 'bg-teal-50 text-teal-700 font-semibold' : 'text-gray-600 hover:bg-gray-50'"
                        class="flex-1 py-3 px-4 rounded-lg transition-colors duration-200">
                    ğŸ“¦ ç‰©å“æŸ¥è©¢
                </button>
                <button @click="switchTab('receive')" 
                        :class="currentTab === 'receive' ? 'bg-teal-50 text-teal-700 font-semibold' : 'text-gray-600 hover:bg-gray-50'"
                        class="flex-1 py-3 px-4 rounded-lg transition-colors duration-200">
                    ğŸ“¥ é€²è²¨
                </button>
                <button @click="switchTab('consume')" 
                        :class="currentTab === 'consume' ? 'bg-teal-50 text-teal-700 font-semibold' : 'text-gray-600 hover:bg-gray-50'"
                        class="flex-1 py-3 px-4 rounded-lg transition-colors duration-200">
                    ğŸ“¤ æ¶ˆè€—
                </button>
                <button @click="switchTab('blood')" 
                        :class="currentTab === 'blood' ? 'bg-teal-50 text-teal-700 font-semibold' : 'text-gray-600 hover:bg-gray-50'"
                        class="flex-1 py-3 px-4 rounded-lg transition-colors duration-200">
                    ğŸ©¸ è¡€è¢‹
                </button>
                <button @click="switchTab('equipment')" 
                        :class="currentTab === 'equipment' ? 'bg-teal-50 text-teal-700 font-semibold' : 'text-gray-600 hover:bg-gray-50'"
                        class="flex-1 py-3 px-4 rounded-lg transition-colors duration-200">
                    ğŸ”§ è¨­å‚™
                </button>
                <button @click="switchTab('surgery')" 
                        :class="currentTab === 'surgery' ? 'bg-teal-50 text-teal-700 font-semibold' : 'text-gray-600 hover:bg-gray-50'"
                        class="flex-1 py-3 px-4 rounded-lg transition-colors duration-200">
                    ğŸ¥ æ‰‹è¡“è¨˜éŒ„
                </button>
            </div>
        </div>

        <!-- ç‰©å“æŸ¥è©¢åˆ†é  -->
        <div x-show="currentTab === 'items'" class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">ğŸ“¦ åº«å­˜æŸ¥è©¢</h2>
                <div class="flex gap-2">
                    <button @click="showAddItemModal = true" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                        â• æ–°å¢ç‰©å“
                    </button>
                    <button @click="loadItems()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                </div>
            </div>

            <!-- v1.4.3 å·¥å…·åˆ— -->
            <div class="items-toolbar">
                <!-- æœå°‹æ¡† -->
                <div class="search-box">
                    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input
                        type="text"
                        x-model="itemSearch"
                        @input="applyFilters()"
                        class="search-input"
                        placeholder="æœå°‹ä»£ç¢¼æˆ–åç¨±..."
                    >
                    <button
                        x-show="itemSearch.length > 0"
                        @click="itemSearch = ''; applyFilters()"
                        class="search-clear"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- åˆ†é¡ç¯©é¸ -->
                <div class="filter-box">
                    <svg class="filter-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    <select x-model="categoryFilter" @change="applyFilters()" class="filter-select">
                        <option value="">å…¨éƒ¨åˆ†é¡</option>
                        <template x-for="cat in categories" :key="cat">
                            <option :value="cat" x-text="cat"></option>
                        </template>
                    </select>
                </div>

                <!-- æ’åºé¸æ“‡ -->
                <div class="sort-box">
                    <svg class="sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"/>
                    </svg>
                    <select x-model="itemSort" @change="applyFilters()" class="sort-select">
                        <option value="code-asc">ä»£ç¢¼ â†‘</option>
                        <option value="code-desc">ä»£ç¢¼ â†“</option>
                        <option value="name-asc">åç¨± A-Z</option>
                        <option value="name-desc">åç¨± Z-A</option>
                        <option value="category-asc">åˆ†é¡ A-Z</option>
                        <option value="category-desc">åˆ†é¡ Z-A</option>
                        <option value="stock-asc">åº«å­˜ â†‘</option>
                        <option value="stock-desc">åº«å­˜ â†“</option>
                    </select>
                </div>

                <!-- CSV åŒ¯å‡ºå¿«æ·æŒ‰éˆ• -->
                <div class="export-box">
                    <button @click="exportItemsCSV('week')" class="btn-export">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        æœ¬é€±
                    </button>
                    <button @click="exportItemsCSV('month')" class="btn-export">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        æœ¬æœˆ
                    </button>
                    <button @click="exportItemsCSV('all')" class="btn-export">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        å…¨éƒ¨
                    </button>
                </div>
            </div>

            <!-- çµæœçµ±è¨ˆ -->
            <div class="items-stats">
                <span>é¡¯ç¤º <strong x-text="filteredItems.length"></strong> / <strong x-text="items.length"></strong> é …ç‰©å“</span>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä»£ç¢¼</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åç¨±</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ†é¡</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åº«å­˜</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€å°åº«å­˜</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å–®ä½</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-if="filteredItems.length === 0">
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                    </svg>
                                    <p class="text-lg font-medium">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç‰©å“</p>
                                    <p class="text-sm">è«‹å˜—è©¦èª¿æ•´æœå°‹æˆ–ç¯©é¸æ¢ä»¶</p>
                                </td>
                            </tr>
                        </template>
                        <template x-for="item in filteredItems" :key="item.code">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="item.code"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="item.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800" x-text="item.category"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span :class="item.current_stock < item.min_stock ? 'text-red-600 font-bold' : 'text-green-600 font-semibold'"
                                          x-text="item.current_stock"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.min_stock"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.unit"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                    <button @click="editItem(item)" class="text-blue-600 hover:text-blue-800">ç·¨è¼¯</button>
                                    <button @click="deleteItem(item.code, item.name)" class="text-red-600 hover:text-red-800">åˆªé™¤</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- é€²è²¨åˆ†é  -->
        <div x-show="currentTab === 'receive'" class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“¥ é€²è²¨ç™»è¨˜</h2>
            
            <form @submit.prevent="submitReceive()" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“ä»£ç¢¼ *</label>
                        <select x-model="receiveForm.itemCode" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            <option value="">è«‹é¸æ“‡ç‰©å“</option>
                            <template x-for="item in items" :key="item.code">
                                <option :value="item.code" x-text="`${item.code} - ${item.name}`"></option>
                            </template>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡ *</label>
                        <input type="number" x-model="receiveForm.quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ‰¹è™Ÿ</label>
                        <input type="text" x-model="receiveForm.batchNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•ˆæœŸ</label>
                        <input type="date" x-model="receiveForm.expiryDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea x-model="receiveForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"></textarea>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                        âœ… ç¢ºèªé€²è²¨
                    </button>
                    <button type="button" @click="resetReceiveForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ğŸ”„ é‡ç½®
                    </button>
                </div>
            </form>
        </div>

        <!-- æ¶ˆè€—åˆ†é  -->
        <div x-show="currentTab === 'consume'" class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“¤ æ¶ˆè€—ç™»è¨˜</h2>
            
            <form @submit.prevent="submitConsume()" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“ä»£ç¢¼ *</label>
                        <select x-model="consumeForm.itemCode" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            <option value="">è«‹é¸æ“‡ç‰©å“</option>
                            <template x-for="item in items" :key="item.code">
                                <option :value="item.code" x-text="`${item.code} - ${item.name} (åº«å­˜: ${item.current_stock})`"></option>
                            </template>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡ *</label>
                        <input type="number" x-model="consumeForm.quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨é€”èªªæ˜ *</label>
                        <textarea x-model="consumeForm.purpose" required rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"></textarea>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                        âœ… ç¢ºèªæ¶ˆè€—
                    </button>
                    <button type="button" @click="resetConsumeForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ğŸ”„ é‡ç½®
                    </button>
                </div>
            </form>
        </div>

        <!-- è¡€è¢‹åˆ†é  -->
        <div x-show="currentTab === 'blood'" class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ©¸ è¡€è¢‹ç®¡ç†</h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <template x-for="blood in bloodInventory" :key="blood.blood_type">
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-red-300 transition-colors">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600" x-text="blood.blood_type"></div>
                            <div class="text-3xl font-bold text-gray-800 my-2" x-text="blood.quantity"></div>
                            <div class="text-sm text-gray-500">å–®ä½ (U)</div>
                        </div>
                    </div>
                </template>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- è¡€è¢‹å…¥åº« -->
                <div class="border-2 border-green-200 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-green-700 mb-4">ğŸ“¥ è¡€è¢‹å…¥åº«</h3>
                    <form @submit.prevent="submitBloodReceive()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è¡€å‹ *</label>
                            <select x-model="bloodReceiveForm.bloodType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">è«‹é¸æ“‡è¡€å‹</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡ (U) *</label>
                            <input type="number" x-model="bloodReceiveForm.quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            âœ… ç¢ºèªå…¥åº«
                        </button>
                    </form>
                </div>

                <!-- è¡€è¢‹å‡ºåº« -->
                <div class="border-2 border-red-200 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-red-700 mb-4">ğŸ“¤ è¡€è¢‹å‡ºåº«</h3>
                    <form @submit.prevent="submitBloodConsume()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è¡€å‹ *</label>
                            <select x-model="bloodConsumeForm.bloodType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="">è«‹é¸æ“‡è¡€å‹</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡ (U) *</label>
                            <input type="number" x-model="bloodConsumeForm.quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <button type="submit" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                            âœ… ç¢ºèªå‡ºåº«
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- è¨­å‚™åˆ†é  -->
        <div x-show="currentTab === 'equipment'" class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">ğŸ”§ è¨­å‚™ç®¡ç†</h2>
                <div class="flex gap-2">
                    <button @click="showAddEquipmentModal = true" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                        â• æ–°å¢è¨­å‚™
                    </button>
                    <button @click="loadEquipment()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¨­å‚™ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åç¨±</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ†é¡</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ•¸é‡</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é›»åŠ›</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€å¾Œæª¢æŸ¥</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="eq in equipment" :key="eq.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="eq.id"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="eq.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800" x-text="eq.category"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="eq.quantity"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="{
                                        'bg-green-100 text-green-800': eq.status === 'NORMAL',
                                        'bg-yellow-100 text-yellow-800': eq.status === 'WARNING',
                                        'bg-red-100 text-red-800': eq.status === 'ERROR',
                                        'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED'
                                    }" class="px-2 py-1 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span x-show="eq.power_level !== null" x-text="eq.power_level + '%'"></span>
                                    <span x-show="eq.power_level === null" class="text-gray-400">-</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                    <button @click="checkEquipment(eq)" class="text-green-600 hover:text-green-800">æª¢æŸ¥</button>
                                    <button @click="editEquipment(eq)" class="text-blue-600 hover:text-blue-800">ç·¨è¼¯</button>
                                    <button @click="deleteEquipment(eq.id, eq.name)" class="text-red-600 hover:text-red-800">åˆªé™¤</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ‰‹è¡“è¨˜éŒ„åˆ†é  -->
        <div x-show="currentTab === 'surgery'" class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">ğŸ¥ æ‰‹è¡“è¨˜éŒ„ç®¡ç†</h2>
                <div class="flex gap-2">
                    <button @click="showAddSurgeryModal = true" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                        â• æ–°å¢æ‰‹è¡“è¨˜éŒ„
                    </button>
                    <button @click="exportSurgeryCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        ğŸ“Š åŒ¯å‡º CSV
                    </button>
                    <button @click="loadSurgeryRecords()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                </div>
            </div>

            <!-- æœå°‹ç¯©é¸ -->
            <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" x-model="surgerySearchForm.startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ—¥æœŸ</label>
                    <input type="date" x-model="surgerySearchForm.endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç—…æ‚£å§“å</label>
                    <input type="text" x-model="surgerySearchForm.patientName" placeholder="æœå°‹ç—…æ‚£..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¨˜éŒ„ç·¨è™Ÿ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç—…æ‚£å§“å</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‰‹è¡“é¡å‹</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸»åˆ€é†«å¸«</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ™‚é•·(åˆ†)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="record in surgeryRecords" :key="record.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="record.record_number"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.record_date"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.patient_name"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgery_type"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgeon_name"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.duration_minutes || '-'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button @click="viewSurgeryDetail(record)" class="text-blue-600 hover:text-blue-800">è©³æƒ…</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ–°å¢ç‰©å“ Modal -->
        <div x-show="showAddItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showAddItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">â• æ–°å¢ç‰©å“</h3>
                <form @submit.prevent="submitAddItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“ä»£ç¢¼ (ç•™ç©ºè‡ªå‹•ç”Ÿæˆ)</label>
                        <input type="text" x-model="addItemForm.code" placeholder="ç•™ç©ºå°‡è‡ªå‹•ç”Ÿæˆ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“åç¨± *</label>
                        <input type="text" x-model="addItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†é¡ *</label>
                        <select x-model="addItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="æ‰‹è¡“è€—æ">æ‰‹è¡“è€—æ</option>
                            <option value="æ€¥æ•‘ç‰©è³‡">æ€¥æ•‘ç‰©è³‡</option>
                            <option value="è—¥å“">è—¥å“</option>
                            <option value="é˜²è­·ç”¨å“">é˜²è­·ç”¨å“</option>
                            <option value="é†«ç™‚è¨­å‚™">é†«ç™‚è¨­å‚™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å–®ä½</label>
                        <input type="text" x-model="addItemForm.unit" placeholder="EA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æœ€å°åº«å­˜</label>
                        <input type="number" x-model="addItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                            âœ… ç¢ºèªæ–°å¢
                        </button>
                        <button type="button" @click="showAddItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç·¨è¼¯ç‰©å“ Modal -->
        <div x-show="showEditItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEditItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">âœï¸ ç·¨è¼¯ç‰©å“</h3>
                <form @submit.prevent="submitEditItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“ä»£ç¢¼</label>
                        <input type="text" x-model="editItemForm.code" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“åç¨± *</label>
                        <input type="text" x-model="editItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†é¡ *</label>
                        <select x-model="editItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="æ‰‹è¡“è€—æ">æ‰‹è¡“è€—æ</option>
                            <option value="æ€¥æ•‘ç‰©è³‡">æ€¥æ•‘ç‰©è³‡</option>
                            <option value="è—¥å“">è—¥å“</option>
                            <option value="é˜²è­·ç”¨å“">é˜²è­·ç”¨å“</option>
                            <option value="é†«ç™‚è¨­å‚™">é†«ç™‚è¨­å‚™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å–®ä½</label>
                        <input type="text" x-model="editItemForm.unit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æœ€å°åº«å­˜</label>
                        <input type="number" x-model="editItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                            âœ… ç¢ºèªæ›´æ–°
                        </button>
                        <button type="button" @click="showEditItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æ–°å¢è¨­å‚™ Modal -->
        <div x-show="showAddEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showAddEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">â• æ–°å¢è¨­å‚™</h3>
                <form @submit.prevent="submitAddEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨­å‚™åç¨± *</label>
                        <input type="text" x-model="addEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†é¡ *</label>
                        <select x-model="addEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="é›»åŠ›è¨­å‚™">é›»åŠ›è¨­å‚™</option>
                            <option value="ç©ºæ°£æ·¨åŒ–">ç©ºæ°£æ·¨åŒ–</option>
                            <option value="æ°´è™•ç†">æ°´è™•ç†</option>
                            <option value="å†·è—è¨­å‚™">å†·è—è¨­å‚™</option>
                            <option value="é€šè¨Šè¨­å‚™">é€šè¨Šè¨­å‚™</option>
                            <option value="ç…§æ˜è¨­å‚™">ç…§æ˜è¨­å‚™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡</label>
                        <input type="number" x-model="addEquipmentForm.quantity" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea x-model="addEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                            âœ… ç¢ºèªæ–°å¢
                        </button>
                        <button type="button" @click="showAddEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç·¨è¼¯è¨­å‚™ Modal -->
        <div x-show="showEditEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEditEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">âœï¸ ç·¨è¼¯è¨­å‚™</h3>
                <form @submit.prevent="submitEditEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨­å‚™ID</label>
                        <input type="text" x-model="editEquipmentForm.id" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨­å‚™åç¨± *</label>
                        <input type="text" x-model="editEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†é¡ *</label>
                        <select x-model="editEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="é›»åŠ›è¨­å‚™">é›»åŠ›è¨­å‚™</option>
                            <option value="ç©ºæ°£æ·¨åŒ–">ç©ºæ°£æ·¨åŒ–</option>
                            <option value="æ°´è™•ç†">æ°´è™•ç†</option>
                            <option value="å†·è—è¨­å‚™">å†·è—è¨­å‚™</option>
                            <option value="é€šè¨Šè¨­å‚™">é€šè¨Šè¨­å‚™</option>
                            <option value="ç…§æ˜è¨­å‚™">ç…§æ˜è¨­å‚™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡</label>
                        <input type="number" x-model="editEquipmentForm.quantity" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea x-model="editEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                            âœ… ç¢ºèªæ›´æ–°
                        </button>
                        <button type="button" @click="showEditEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¨­å‚™æª¢æŸ¥ Modal -->
        <div x-show="showCheckEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showCheckEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ” è¨­å‚™æª¢æŸ¥</h3>
                <form @submit.prevent="submitCheckEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨­å‚™åç¨±</label>
                        <input type="text" x-model="checkEquipmentForm.name" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‹€æ…‹ *</label>
                        <select x-model="checkEquipmentForm.status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="NORMAL">æ­£å¸¸ (NORMAL)</option>
                            <option value="WARNING">è­¦å‘Š (WARNING)</option>
                            <option value="ERROR">ç•°å¸¸ (ERROR)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é›»åŠ›ç­‰ç´š (0-100%)</label>
                        <input type="number" x-model="checkEquipmentForm.powerLevel" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea x-model="checkEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                            âœ… ç¢ºèªæª¢æŸ¥
                        </button>
                        <button type="button" @click="showCheckEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æ–°å¢æ‰‹è¡“è¨˜éŒ„ Modal -->
        <div x-show="showAddSurgeryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showAddSurgeryModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ¥ æ–°å¢æ‰‹è¡“è¨˜éŒ„</h3>
                <form @submit.prevent="submitAddSurgery()" class="space-y-4">
                    <!-- åŸºæœ¬è³‡è¨Š -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç—…æ‚£å§“å *</label>
                            <input type="text" x-model="addSurgeryForm.patientName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‰‹è¡“é¡å‹ *</label>
                            <input type="text" x-model="addSurgeryForm.surgeryType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä¸»åˆ€é†«å¸« *</label>
                            <input type="text" x-model="addSurgeryForm.surgeonName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">éº»é†‰æ–¹å¼</label>
                            <input type="text" x-model="addSurgeryForm.anesthesiaType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‰‹è¡“æ™‚é•· (åˆ†é˜)</label>
                            <input type="number" x-model="addSurgeryForm.durationMinutes" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                        </div>
                    </div>

                    <!-- å‚™è¨» -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ‰‹è¡“å‚™è¨»</label>
                        <textarea x-model="addSurgeryForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></textarea>
                    </div>

                    <!-- è€—ææ¸…å–® -->
                    <div class="border-2 border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700">ğŸ“‹ ä½¿ç”¨è€—æ</h4>
                            <button type="button" @click="addConsumptionItem()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 text-sm">
                                â• æ–°å¢è€—æ
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in addSurgeryForm.consumptions" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <select x-model="item.itemCode" @change="updateConsumptionItemName(index)" required class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                                            <option value="">é¸æ“‡ç‰©å“</option>
                                            <template x-for="availableItem in items" :key="availableItem.code">
                                                <option :value="availableItem.code" x-text="`${availableItem.code} - ${availableItem.name}`"></option>
                                            </template>
                                        </select>
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="æ•¸é‡" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                                        <input type="text" x-model="item.unit" readonly placeholder="å–®ä½" class="px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                    </div>
                                    <button type="button" @click="removeConsumptionItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="addSurgeryForm.consumptions.length === 0" class="text-center text-gray-400 py-4">
                            å°šæœªæ–°å¢è€—æ
                        </div>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                            âœ… ç¢ºèªå»ºç«‹
                        </button>
                        <button type="button" @click="showAddSurgeryModal = false; resetAddSurgeryForm()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æ‰‹è¡“è©³æƒ… Modal -->
        <div x-show="showSurgeryDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showSurgeryDetailModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ¥ æ‰‹è¡“è¨˜éŒ„è©³æƒ…</h3>
                
                <template x-if="selectedSurgery">
                    <div class="space-y-4">
                        <!-- åŸºæœ¬è³‡è¨Š -->
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">è¨˜éŒ„ç·¨è™Ÿ</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_number"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">æ—¥æœŸ</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_date"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ç—…æ‚£å§“å</p>
                                <p class="font-semibold" x-text="selectedSurgery.patient_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ç•¶æ—¥ç¬¬ N å°</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_sequence"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">æ‰‹è¡“é¡å‹</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_type"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ä¸»åˆ€é†«å¸«</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgeon_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">éº»é†‰æ–¹å¼</p>
                                <p class="font-semibold" x-text="selectedSurgery.anesthesia_type || '-'"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">æ‰‹è¡“æ™‚é•·</p>
                                <p class="font-semibold" x-text="selectedSurgery.duration_minutes ? selectedSurgery.duration_minutes + ' åˆ†é˜' : '-'"></p>
                            </div>
                        </div>

                        <!-- å‚™è¨» -->
                        <div x-show="selectedSurgery.remarks" class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">å‚™è¨»</p>
                            <p class="text-gray-800" x-text="selectedSurgery.remarks"></p>
                        </div>

                        <!-- è€—ææ¸…å–® -->
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3">ğŸ“‹ ä½¿ç”¨è€—æ</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ä»£ç¢¼</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">åç¨±</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ•¸é‡</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">å–®ä½</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="consumption in selectedSurgery.consumptions" :key="consumption.item_code">
                                            <tr>
                                                <td class="px-4 py-2 text-sm font-mono" x-text="consumption.item_code"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.item_name"></td>
                                                <td class="px-4 py-2 text-sm font-semibold" x-text="consumption.quantity"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.unit"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="button" @click="showSurgeryDetailModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Toast é€šçŸ¥ -->
        <div x-show="showToast" x-transition class="fixed bottom-4 right-4 z-50" style="display: none;">
            <div :class="{
                'bg-green-500': toastType === 'success',
                'bg-red-500': toastType === 'error',
                'bg-blue-500': toastType === 'info'
            }" class="text-white px-6 py-3 rounded-lg shadow-lg">
                <p x-text="toastMessage"></p>
            </div>
        </div>

    </div>

    <script>
        function medicalInventory() {
            return {
                // åŸºæœ¬è¨­å®š
                apiUrl: 'http://localhost:8000/api',
                stationId: 'TC-01',
                currentTab: 'items',
                currentTime: '',
                
                // è³‡æ–™
                items: [],
                filteredItems: [],
                bloodInventory: [],
                equipment: [],
                surgeryRecords: [],
                stats: {
                    totalItems: 0,
                    lowStockItems: 0,
                    totalBlood: 0,
                    equipmentAlerts: 0
                },

                // v1.4.3 æ–°å¢ï¼šæœå°‹èˆ‡ç¯©é¸
                itemSearch: '',
                categoryFilter: '',
                itemSort: 'code-asc',
                categories: [],

                // Modal ç‹€æ…‹
                showAddItemModal: false,
                showEditItemModal: false,
                showAddEquipmentModal: false,
                showEditEquipmentModal: false,
                showCheckEquipmentModal: false,
                showAddSurgeryModal: false,
                showSurgeryDetailModal: false,

                // è¡¨å–®
                receiveForm: {
                    itemCode: '',
                    quantity: 1,
                    batchNumber: '',
                    expiryDate: '',
                    remarks: '',
                    stationId: 'TC-01'
                },
                consumeForm: {
                    itemCode: '',
                    quantity: 1,
                    purpose: '',
                    stationId: 'TC-01'
                },
                bloodReceiveForm: {
                    bloodType: '',
                    quantity: 1,
                    stationId: 'TC-01'
                },
                bloodConsumeForm: {
                    bloodType: '',
                    quantity: 1,
                    stationId: 'TC-01'
                },
                addItemForm: {
                    code: '',
                    name: '',
                    unit: 'EA',
                    minStock: 10,
                    category: 'å…¶ä»–'
                },
                editItemForm: {
                    code: '',
                    name: '',
                    unit: '',
                    minStock: 0,
                    category: ''
                },
                addEquipmentForm: {
                    name: '',
                    category: 'å…¶ä»–',
                    quantity: 1,
                    remarks: ''
                },
                editEquipmentForm: {
                    id: '',
                    name: '',
                    category: '',
                    quantity: 1,
                    remarks: ''
                },
                checkEquipmentForm: {
                    id: '',
                    name: '',
                    status: 'NORMAL',
                    powerLevel: null,
                    remarks: '',
                    stationId: 'TC-01'
                },
                addSurgeryForm: {
                    patientName: '',
                    surgeryType: '',
                    surgeonName: '',
                    anesthesiaType: '',
                    durationMinutes: null,
                    remarks: '',
                    consumptions: [],
                    stationId: 'TC-01'
                },
                surgerySearchForm: {
                    startDate: '',
                    endDate: '',
                    patientName: ''
                },
                selectedSurgery: null,

                // Toast
                showToast: false,
                toastMessage: '',
                toastType: 'info',

                // åˆå§‹åŒ–
                async init() {
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);
                    
                    await this.loadStats();
                    await this.loadItems();
                    await this.loadBloodInventory();
                    await this.loadEquipment();
                    await this.loadSurgeryRecords();
                },

                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                },

                // åˆ†é åˆ‡æ›
                switchTab(tab) {
                    this.currentTab = tab;
                    if (tab === 'items') this.loadItems();
                    if (tab === 'blood') this.loadBloodInventory();
                    if (tab === 'equipment') this.loadEquipment();
                    if (tab === 'surgery') this.loadSurgeryRecords();
                },

                // è¼‰å…¥çµ±è¨ˆ
                async loadStats() {
                    try {
                        const response = await fetch(`${this.apiUrl}/stats`);
                        if (response.ok) {
                            this.stats = await response.json();
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
                    }
                },

                // è¼‰å…¥ç‰©å“
                async loadItems() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`);
                        if (response.ok) {
                            const data = await response.json();
                            this.items = data.items;
                            this.updateCategories();
                            this.applyFilters();
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥ç‰©å“å¤±æ•—:', error);
                        this.toast('è¼‰å…¥ç‰©å“å¤±æ•—', 'error');
                    }
                },

                // v1.4.3 æ–°å¢ï¼šæ›´æ–°åˆ†é¡åˆ—è¡¨
                updateCategories() {
                    const uniqueCategories = [...new Set(this.items.map(item => item.category))];
                    this.categories = uniqueCategories.sort();
                },

                // v1.4.3 æ–°å¢ï¼šæ‡‰ç”¨ç¯©é¸èˆ‡æ’åº
                applyFilters() {
                    let filtered = [...this.items];

                    // 1. æœå°‹éæ¿¾
                    if (this.itemSearch.trim()) {
                        const searchTerm = this.itemSearch.toLowerCase().trim();
                        filtered = filtered.filter(item =>
                            item.code.toLowerCase().includes(searchTerm) ||
                            item.name.toLowerCase().includes(searchTerm)
                        );
                    }

                    // 2. åˆ†é¡ç¯©é¸
                    if (this.categoryFilter) {
                        filtered = filtered.filter(item => item.category === this.categoryFilter);
                    }

                    // 3. æ’åº
                    const [field, order] = this.itemSort.split('-');
                    filtered.sort((a, b) => {
                        let compareA, compareB;

                        switch(field) {
                            case 'code':
                                compareA = a.code;
                                compareB = b.code;
                                break;
                            case 'name':
                                compareA = a.name;
                                compareB = b.name;
                                break;
                            case 'category':
                                compareA = a.category;
                                compareB = b.category;
                                break;
                            case 'stock':
                                compareA = a.current_stock || 0;
                                compareB = b.current_stock || 0;
                                break;
                        }

                        // å­—ä¸²æ¯”è¼ƒï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                        if (typeof compareA === 'string') {
                            compareA = compareA.toLowerCase();
                            compareB = compareB.toLowerCase();
                        }

                        if (order === 'asc') {
                            return compareA > compareB ? 1 : -1;
                        } else {
                            return compareA < compareB ? 1 : -1;
                        }
                    });

                    this.filteredItems = filtered;
                },

                // v1.4.3 æ–°å¢ï¼šCSV åŒ¯å‡º
                exportItemsCSV(range) {
                    let itemsToExport = [...this.filteredItems];
                    const now = new Date();
                    let filename = '';

                    if (range === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        filename = `ç‰©å“æ¸…å–®_æœ¬é€±_${this.formatDate(now)}.csv`;
                    } else if (range === 'month') {
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        filename = `ç‰©å“æ¸…å–®_æœ¬æœˆ_${this.formatDate(now)}.csv`;
                    } else {
                        filename = `ç‰©å“æ¸…å–®_å…¨éƒ¨_${this.formatDate(now)}.csv`;
                    }

                    // ç”Ÿæˆ CSV
                    const headers = ['ä»£ç¢¼', 'åç¨±', 'åˆ†é¡', 'ç•¶å‰åº«å­˜', 'æœ€å°åº«å­˜', 'å–®ä½'];
                    const rows = itemsToExport.map(item => [
                        item.code,
                        item.name,
                        item.category,
                        item.current_stock || 0,
                        item.min_stock || 0,
                        item.unit || ''
                    ]);

                    const csv = [
                        headers.join(','),
                        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                    ].join('\n');

                    // ä¸‹è¼‰
                    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // æç¤º
                    this.toast(`å·²åŒ¯å‡º ${itemsToExport.length} é …ç‰©å“`, 'success');
                },

                // v1.4.3 æ–°å¢ï¼šæ—¥æœŸæ ¼å¼åŒ–
                formatDate(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}${month}${day}`;
                },

                // æ–°å¢ç‰©å“
                async submitAddItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addItemForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ç‰©å“æ–°å¢æˆåŠŸ', 'success');
                            this.showAddItemModal = false;
                            this.resetAddItemForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'æ–°å¢å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ–°å¢ç‰©å“å¤±æ•—:', error);
                        this.toast('æ–°å¢ç‰©å“å¤±æ•—', 'error');
                    }
                },

                resetAddItemForm() {
                    this.addItemForm = {
                        code: '',
                        name: '',
                        unit: 'EA',
                        minStock: 10,
                        category: 'å…¶ä»–'
                    };
                },

                // ç·¨è¼¯ç‰©å“
                editItem(item) {
                    this.editItemForm = {
                        code: item.code,
                        name: item.name,
                        unit: item.unit,
                        minStock: item.min_stock,
                        category: item.category
                    };
                    this.showEditItemModal = true;
                },

                async submitEditItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${this.editItemForm.code}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editItemForm.name,
                                unit: this.editItemForm.unit,
                                minStock: this.editItemForm.minStock,
                                category: this.editItemForm.category
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ç‰©å“æ›´æ–°æˆåŠŸ', 'success');
                            this.showEditItemModal = false;
                            await this.loadItems();
                        } else {
                            this.toast(data.detail || 'æ›´æ–°å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ›´æ–°ç‰©å“å¤±æ•—:', error);
                        this.toast('æ›´æ–°ç‰©å“å¤±æ•—', 'error');
                    }
                },

                // åˆªé™¤ç‰©å“
                async deleteItem(code, name) {
                    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç‰©å“ã€Œ${name}ã€å—?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${code}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ç‰©å“å·²åˆªé™¤', 'success');
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'åˆªé™¤å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('åˆªé™¤ç‰©å“å¤±æ•—:', error);
                        this.toast('åˆªé™¤ç‰©å“å¤±æ•—', 'error');
                    }
                },

                // é€²è²¨
                async submitReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.receiveForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'é€²è²¨è¨˜éŒ„æˆåŠŸ', 'success');
                            this.resetReceiveForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'é€²è²¨å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('é€²è²¨å¤±æ•—:', error);
                        this.toast('é€²è²¨å¤±æ•—', 'error');
                    }
                },

                resetReceiveForm() {
                    this.receiveForm = {
                        itemCode: '',
                        quantity: 1,
                        batchNumber: '',
                        expiryDate: '',
                        remarks: '',
                        stationId: this.stationId
                    };
                },

                // æ¶ˆè€—
                async submitConsume() {
                    try {
                        const response = await fetch(`${this.apiUrl}/consume`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.consumeForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'æ¶ˆè€—è¨˜éŒ„æˆåŠŸ', 'success');
                            this.resetConsumeForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'æ¶ˆè€—å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ¶ˆè€—å¤±æ•—:', error);
                        this.toast('æ¶ˆè€—å¤±æ•—', 'error');
                    }
                },

                resetConsumeForm() {
                    this.consumeForm = {
                        itemCode: '',
                        quantity: 1,
                        purpose: '',
                        stationId: this.stationId
                    };
                },

                // è¡€è¢‹
                async loadBloodInventory() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/inventory`);
                        if (response.ok) {
                            const data = await response.json();
                            this.bloodInventory = data.bloodInventory;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¡€è¢‹åº«å­˜å¤±æ•—:', error);
                    }
                },

                async submitBloodReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodReceiveForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'è¡€è¢‹å…¥åº«æˆåŠŸ', 'success');
                            this.bloodReceiveForm = { bloodType: '', quantity: 1, stationId: this.stationId };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'å…¥åº«å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¡€è¢‹å…¥åº«å¤±æ•—:', error);
                        this.toast('è¡€è¢‹å…¥åº«å¤±æ•—', 'error');
                    }
                },

                async submitBloodConsume() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/consume`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodConsumeForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'è¡€è¢‹å‡ºåº«æˆåŠŸ', 'success');
                            this.bloodConsumeForm = { bloodType: '', quantity: 1, stationId: this.stationId };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'å‡ºåº«å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¡€è¢‹å‡ºåº«å¤±æ•—:', error);
                        this.toast('è¡€è¢‹å‡ºåº«å¤±æ•—', 'error');
                    }
                },

                // è¨­å‚™ç®¡ç†
                async loadEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment`);
                        if (response.ok) {
                            const data = await response.json();
                            this.equipment = data.equipment;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¨­å‚™å¤±æ•—:', error);
                        this.toast('è¼‰å…¥è¨­å‚™å¤±æ•—', 'error');
                    }
                },

                async submitAddEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addEquipmentForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'è¨­å‚™æ–°å¢æˆåŠŸ', 'success');
                            this.showAddEquipmentModal = false;
                            this.resetAddEquipmentForm();
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'æ–°å¢å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ–°å¢è¨­å‚™å¤±æ•—:', error);
                        this.toast('æ–°å¢è¨­å‚™å¤±æ•—', 'error');
                    }
                },

                resetAddEquipmentForm() {
                    this.addEquipmentForm = {
                        name: '',
                        category: 'å…¶ä»–',
                        quantity: 1,
                        remarks: ''
                    };
                },

                editEquipment(eq) {
                    this.editEquipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        category: eq.category,
                        quantity: eq.quantity,
                        remarks: eq.remarks || ''
                    };
                    this.showEditEquipmentModal = true;
                },

                async submitEditEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${this.editEquipmentForm.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editEquipmentForm.name,
                                category: this.editEquipmentForm.category,
                                quantity: this.editEquipmentForm.quantity,
                                remarks: this.editEquipmentForm.remarks
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'è¨­å‚™æ›´æ–°æˆåŠŸ', 'success');
                            this.showEditEquipmentModal = false;
                            await this.loadEquipment();
                        } else {
                            this.toast(data.detail || 'æ›´æ–°å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ›´æ–°è¨­å‚™å¤±æ•—:', error);
                        this.toast('æ›´æ–°è¨­å‚™å¤±æ•—', 'error');
                    }
                },

                async deleteEquipment(id, name) {
                    if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¨­å‚™ã€Œ${name}ã€å—?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${id}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'è¨­å‚™å·²åˆªé™¤', 'success');
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'åˆªé™¤å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('åˆªé™¤è¨­å‚™å¤±æ•—:', error);
                        this.toast('åˆªé™¤è¨­å‚™å¤±æ•—', 'error');
                    }
                },

                checkEquipment(eq) {
                    this.checkEquipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        status: 'NORMAL',
                        powerLevel: eq.power_level,
                        remarks: '',
                        stationId: this.stationId
                    };
                    this.showCheckEquipmentModal = true;
                },

                async submitCheckEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/check/${this.checkEquipmentForm.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stationId: this.checkEquipmentForm.stationId,
                                status: this.checkEquipmentForm.status,
                                powerLevel: this.checkEquipmentForm.powerLevel,
                                remarks: this.checkEquipmentForm.remarks
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'è¨­å‚™æª¢æŸ¥å®Œæˆ', 'success');
                            this.showCheckEquipmentModal = false;
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'æª¢æŸ¥å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¨­å‚™æª¢æŸ¥å¤±æ•—:', error);
                        this.toast('è¨­å‚™æª¢æŸ¥å¤±æ•—', 'error');
                    }
                },

                // æ‰‹è¡“è¨˜éŒ„
                async loadSurgeryRecords() {
                    try {
                        let url = `${this.apiUrl}/surgery/records?limit=50`;
                        
                        if (this.surgerySearchForm.startDate) {
                            url += `&start_date=${this.surgerySearchForm.startDate}`;
                        }
                        if (this.surgerySearchForm.endDate) {
                            url += `&end_date=${this.surgerySearchForm.endDate}`;
                        }
                        if (this.surgerySearchForm.patientName) {
                            url += `&patient_name=${encodeURIComponent(this.surgerySearchForm.patientName)}`;
                        }
                        
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.surgeryRecords = data.records;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥æ‰‹è¡“è¨˜éŒ„å¤±æ•—:', error);
                        this.toast('è¼‰å…¥æ‰‹è¡“è¨˜éŒ„å¤±æ•—', 'error');
                    }
                },

                addConsumptionItem() {
                    this.addSurgeryForm.consumptions.push({
                        itemCode: '',
                        itemName: '',
                        quantity: 1,
                        unit: ''
                    });
                },

                removeConsumptionItem(index) {
                    this.addSurgeryForm.consumptions.splice(index, 1);
                },

                updateConsumptionItemName(index) {
                    const itemCode = this.addSurgeryForm.consumptions[index].itemCode;
                    const item = this.items.find(i => i.code === itemCode);
                    if (item) {
                        this.addSurgeryForm.consumptions[index].itemName = item.name;
                        this.addSurgeryForm.consumptions[index].unit = item.unit;
                    }
                },

                async submitAddSurgery() {
                    if (this.addSurgeryForm.consumptions.length === 0) {
                        this.toast('è«‹è‡³å°‘æ–°å¢ä¸€é …è€—æ', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/surgery/record`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addSurgeryForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'æ‰‹è¡“è¨˜éŒ„å»ºç«‹æˆåŠŸ', 'success');
                            this.showAddSurgeryModal = false;
                            this.resetAddSurgeryForm();
                            await this.loadSurgeryRecords();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'å»ºç«‹å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('å»ºç«‹æ‰‹è¡“è¨˜éŒ„å¤±æ•—:', error);
                        this.toast('å»ºç«‹æ‰‹è¡“è¨˜éŒ„å¤±æ•—', 'error');
                    }
                },

                resetAddSurgeryForm() {
                    this.addSurgeryForm = {
                        patientName: '',
                        surgeryType: '',
                        surgeonName: '',
                        anesthesiaType: '',
                        durationMinutes: null,
                        remarks: '',
                        consumptions: [],
                        stationId: this.stationId
                    };
                },

                async viewSurgeryDetail(record) {
                    try {
                        // å¾ API ç²å–å®Œæ•´çš„æ‰‹è¡“è¨˜éŒ„è©³æƒ…ï¼ˆåŒ…å«è€—ææ¸…å–®ï¼‰
                        const response = await fetch(`${this.apiUrl}/surgery/record/${record.id}`);
                        if (response.ok) {
                            const data = await response.json();
                            this.selectedSurgery = data.record;
                            this.showSurgeryDetailModal = true;
                        } else {
                            this.toast('ç„¡æ³•è¼‰å…¥æ‰‹è¡“è¨˜éŒ„è©³æƒ…', 'error');
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥æ‰‹è¡“è¨˜éŒ„è©³æƒ…å¤±æ•—:', error);
                        this.toast('è¼‰å…¥æ‰‹è¡“è¨˜éŒ„è©³æƒ…å¤±æ•—', 'error');
                    }
                },

                async exportSurgeryCSV() {
                    try {
                        let url = `${this.apiUrl}/surgery/export/csv`;
                        const params = [];
                        
                        if (this.surgerySearchForm.startDate) {
                            params.push(`start_date=${this.surgerySearchForm.startDate}`);
                        }
                        if (this.surgerySearchForm.endDate) {
                            params.push(`end_date=${this.surgerySearchForm.endDate}`);
                        }
                        
                        if (params.length > 0) {
                            url += '?' + params.join('&');
                        }
                        
                        window.open(url, '_blank');
                        this.toast('CSV åŒ¯å‡ºæˆåŠŸ', 'success');
                    } catch (error) {
                        console.error('åŒ¯å‡º CSV å¤±æ•—:', error);
                        this.toast('åŒ¯å‡º CSV å¤±æ•—', 'error');
                    }
                },

                // Toast é€šçŸ¥
                toast(message, type = 'info') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                }
            };
        }
    </script>
</body>
</html>
